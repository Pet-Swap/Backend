databaseChangeLog:
  - changeSet:
      id: create-profiles-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: profiles
            columns:
              - column:
                  name: user_id
                  type: UUID
                  constraints:
                    primaryKey: true
              - column:
                  name: username
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: password
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: avatar_url
                  type: TEXT
              - column:
                  name: role
                  type: VARCHAR(20)
                  constraints:
                    checkConstraint: role IN ('owner', 'pet_sitter', 'both')
              - column:
                  name: bio
                  type: TEXT
              - column:
                  name: rating
                  type: FLOAT
                  defaultValue: 0
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()

  - changeSet:
      id: create-pets-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: pets
            columns:
              - column:
                  name: pet_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: owner_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_pets_profiles
                    references: profiles(user_id)
              - column:
                  name: name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: species
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: breed
                  type: VARCHAR(50)
              - column:
                  name: age
                  type: INTEGER
              - column:
                  name: photo_url
                  type: TEXT
              - column:
                  name: special_notes
                  type: TEXT

  - changeSet:
      id: create-listings-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: listings
            columns:
              - column:
                  name: listing_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: owner_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_listings_profiles
                    references: profiles(user_id)
              - column:
                  name: pet_id
                  type: INTEGER
                  constraints:
                    nullable: false
                    foreignKeyName: fk_listings_pets
                    references: pets(pet_id)
              - column:
                  name: title
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: description
                  type: TEXT
              - column:
                  name: start_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: end_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: price_per_day
                  type: NUMERIC(10,2)
              - column:
                  name: latitude
                  type: NUMERIC(9,6)
                  constraints:
                    nullable: true
              - column:
                  name: longitude
                  type: NUMERIC(9,6)
                  constraints:
                    nullable: true
              - column:
                  name: status
                  type: VARCHAR(20)
                  defaultValue: ACTIVE
                  constraints:
                    checkConstraint: status IN ('ACTIVE', 'RESERVED', 'COMPLETED', 'INACTIVE')
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()

  - changeSet:
      id: create-swipes-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: swipes
            columns:
              - column:
                  name: swipe_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: swiper_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_swipes_profiles
                    references: profiles(user_id)
              - column:
                  name: listing_id
                  type: INTEGER
                  constraints:
                    nullable: false
                    foreignKeyName: fk_swipes_listings
                    references: listings(listing_id)
              - column:
                  name: direction
                  type: VARCHAR(10)
                  constraints:
                    nullable: false
                    checkConstraint: direction IN ('like', 'pass')
              - column:
                  name: swiped_at
                  type: timestamptz
                  defaultValueComputed: NOW()
            constraints:
              - uniqueConstraint:
                  name: uk_swipes_swiper_listing
                  columnNames: swiper_id,listing_id

  - changeSet:
      id: create-matches-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: matches
            columns:
              - column:
                  name: match_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: listing_id
                  type: INTEGER
                  constraints:
                    nullable: false
                    foreignKeyName: fk_matches_listings
                    references: listings(listing_id)
              - column:
                  name: pet_sitter_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_matches_profiles
                    references: profiles(user_id)
              - column:
                  name: owner_liked_back
                  type: BOOLEAN
                  defaultValue: false
              - column:
                  name: matched_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()
            constraints:
              - uniqueConstraint:
                  name: uk_matches_listing_pet_sitter
                  columnNames: listing_id,pet_sitter_id

  - changeSet:
      id: create-messages-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: messages
            columns:
              - column:
                  name: message_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: match_id
                  type: INTEGER
                  constraints:
                    nullable: false
                    foreignKeyName: fk_messages_matches
                    references: matches(match_id)
              - column:
                  name: sender_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_messages_profiles
                    references: profiles(user_id)
              - column:
                  name: content
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: sent_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()

  - changeSet:
      id: create-bookings-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: bookings
            columns:
              - column:
                  name: booking_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: match_id
                  type: INTEGER
                  constraints:
                    nullable: false
                    foreignKeyName: fk_bookings_matches
                    references: matches(match_id)
              - column:
                  name: start_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: end_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: total_price
                  type: DECIMAL(10,2)
              - column:
                  name: status
                  type: VARCHAR(20)
                  defaultValue: PENDING
                  constraints:
                    checkConstraint: status IN ('PENDING', 'CONFIRMED', 'IN_PROGRESS', 'COMPLETED', 'CANCELLED')
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()

  - changeSet:
      id: create-reviews-table
      author: sylvain-costes
      changes:
        - createTable:
            tableName: reviews
            columns:
              - column:
                  name: review_id
                  type: SERIAL
                  constraints:
                    primaryKey: true
              - column:
                  name: booking_id
                  type: INTEGER
                  constraints:
                    nullable: false
                    foreignKeyName: fk_reviews_bookings
                    references: bookings(booking_id)
              - column:
                  name: reviewer_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_reviews_profiles
                    references: profiles(user_id)
              - column:
                  name: rating
                  type: INTEGER
                  constraints:
                    nullable: false
                    checkConstraint: rating >= 1 AND rating <= 5
              - column:
                  name: comment
                  type: TEXT
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: NOW()

  - changeSet:
      id: add-location-column-to-listings
      author: sylvain-costes
      changes:
        - addColumn:
            tableName: listings
            columns:
              - column:
                  name: location
                  type: VARCHAR(255)

  - changeSet:
      id: add-rebooking-columns-to-bookings
      author: sylvain-costes
      changes:
        - addColumn:
            tableName: bookings
            columns:
              - column:
                  name: is_rebooking
                  type: BOOLEAN
                  defaultValue: false
              - column:
                  name: original_booking_id
                  type: INTEGER
                  constraints:
                    foreignKeyName: fk_bookings_original_booking
                    references: bookings(booking_id)

  - changeSet:
      id: add-special-requests-column-to-bookings
      author: sylvain-costes
      changes:
        - addColumn:
            tableName: bookings
            columns:
              - column:
                  name: special_requests
                  type: TEXT

  - changeSet:
      id: add-reviewed-user-column-to-reviews
      author: sylvain-costes
      changes:
        - addColumn:
            tableName: reviews
            columns:
              - column:
                  name: reviewed_user_id
                  type: UUID
                  constraints:
                    nullable: false
                    foreignKeyName: fk_reviews_reviewed_user
                    references: profiles(user_id)

  - changeSet:
      id: add-unique-constraint-reviews
      author: sylvain-costes
      changes:
        - addUniqueConstraint:
            tableName: reviews
            columnNames: booking_id,reviewer_id
            constraintName: uk_reviews_booking_reviewer
